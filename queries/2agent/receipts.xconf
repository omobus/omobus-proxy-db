<?xml version="1.0" encoding="utf-8"?>
<receipts templ="%doc_id%;%fix_dt%;%doc_no%;%user_id%;%dev_login%;%account_id%;%receipt_type_id%;%doc_note%;%amount%;">
  <![CDATA[
select h.distr_id person_id,
    h.doc_id, h.fix_dt, h.doc_no, coalesce(s2.t_id, h.user_id) user_id, h.dev_login, s0.t_id account_id, h.doc_note, h.amount, h.receipt_type_id
from h_receipt h
    left join symlinks s0 on h.distr_id = s0.distr_id and h.account_id = s0.f_id and s0.obj_code = 'account'
    left join symlinks s2 on h.distr_id = s2.distr_id and h.user_id = s2.f_id and s2.obj_code = 'user'
where h.inserted_ts::date >= current_date - 5
    and s0.t_id is not null
    and (select count(*) from j_docs where doc_id=h.doc_id and (ttd is null or ttd='delivered')) > 0
order by h.distr_id, h.doc_id
  ]]>
</receipts>